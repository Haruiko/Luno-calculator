<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<meta name="description" content="Calculate crafting profits with materials cost, success rates, and daily focus optimization">
<title>Luno Profit Calculator</title>
<style>
  /* palette tuned to the screenshot */
  :root{
    --bg:#0b1220;           /* page background */
    --card:#0f172a;         /* cards */
    --border:#1f2937;       /* subtle borders */
    --muted:#94a3b8;        /* secondary text */
    --text:#e2e8f0;         /* primary text */
    --accent:#2563eb;       /* blue accents */
    --gap:10px; --pad:12px; --radius:12px;
  }

  * { box-sizing: border-box; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
  body { margin: 0; padding: 24px; background: var(--bg); color: var(--text); }
  h1,h2,h3 { margin: 0 0 8px; }
  .wrap { max-width: 1100px; margin: 0 auto; display: grid; gap: 16px; }

  /* Header bar with Home button */
  .topbar{
    display:flex; align-items:center; justify-content:space-between;
    padding: 16px 18px; background: var(--card); border:1px solid var(--border);
    border-radius: 16px;
  }
  .topbar h1{ margin:0; font-size: 24px; }
  .home-btn{
    display:inline-flex; align-items:center; gap:8px; padding:8px 14px;
    border-radius: 10px; border:1px solid #334155; background:#0b1220; color:var(--text);
    text-decoration:none; font-weight:500;
  }
  .home-btn:hover{ border-color:#60a5fa; background:#0f172a; }
  .home-btn .arrow{ font-size:16px; line-height:1; }

  .card { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); padding: var(--pad); }
  .row { display: grid; grid-template-columns: repeat(12, 1fr); gap: var(--gap); align-items: center; }
  .row + .row { margin-top: var(--gap); }

  /* responsive inputs row so ‚ÄúDeposit fee‚Äù can sit beside Daily focus */
  .inputs-row{
    display:grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: var(--gap);
    align-items: start;
  }

  label { font-size: 12px; color: var(--muted); display:block; margin-bottom: 6px; }
  input[type="number"], input[type="text"] {
    width: 100%; padding: 10px; border-radius: 10px; border: 1px solid #334155;
    background: #0b1220; color: var(--text); transition: border-color 0.2s ease;
  }
  input[type="number"]:focus, input[type="text"]:focus { outline: 2px solid #2563eb22; border-color: #60a5fa; }
  input.error { border-color: #ef4444; background: rgba(239, 68, 68, 0.05); }
  input.success { border-color: #22c55e; }

  button { border: 1px solid #334155; background: #0b1220; color: var(--text); padding: 10px 12px; border-radius: 10px; cursor:pointer; }
  button:hover { border-color:#60a5fa; background:#0f172a; }

  .danger { background:#3b0d0d; border-color:#7f1d1d; }
  .success { color:#34d399; }
  .warn { color:#f59e0b; }
  .muted { color: var(--muted); }
  .flex { display:flex; gap:10px; flex-wrap:wrap; }
  .right { text-align:right; }
  .grid-2 { display:grid; grid-template-columns: 1fr 1fr; gap: 16px; }
  .pill { font-size: 12px; padding: 4px 8px; border-radius: 999px; border:1px solid #334155; background:#0b1220; }
  .hr { height:1px; background:#1f2937; margin: 12px 0; border:0; }
  .table { width:100%; border-collapse: collapse; }
  .table th, .table td { border-bottom:1px solid #1f2937; padding:10px; text-align:left; }
  .table th { color:#9ca3af; font-weight:600; }
  .total { font-weight:700; }
  .footer { color:#9ca3af; font-size:12px; }
  .small { font-size: 12px; }
  .hidden {display: none;}
  
  /* Loading indicator */
  .loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(11, 18, 32, 0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease;
  }
  
  .loading-overlay.show {
    opacity: 1;
    visibility: visible;
  }
  
  .spinner {
    width: 40px;
    height: 40px;
    border: 4px solid rgba(94, 160, 224, 0.3);
    border-top: 4px solid #5fa0e0;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  /* Enhanced Mobile Styles */
  @media (max-width: 768px) {
    body { padding: 16px; }
    .wrap { gap: 12px; }
    .topbar { 
      flex-direction: column; 
      align-items: flex-start; 
      gap: 12px; 
    }
    .topbar h1 { font-size: 20px; }
    .inputs-row { 
      grid-template-columns: 1fr;
      gap: 12px;
    }
    .grid-2 { 
      grid-template-columns: 1fr;
      gap: 12px;
    }
    .table { font-size: 14px; }
    .table th, .table td { padding: 8px; }
    input[type="number"], input[type="text"] { 
      padding: 12px; 
      font-size: 16px; /* Prevents zoom on iOS */
    }
    button { 
      padding: 12px 16px; 
      font-size: 14px;
    }
  }

  @media (max-width: 480px) {
    body { padding: 12px; }
    .topbar { padding: 12px; }
    .card { padding: 12px; }
    .topbar h1 { font-size: 18px; }
    .home-btn { padding: 6px 10px; font-size: 13px; }
    .table { 
      font-size: 13px;
      display: block;
      overflow-x: auto;
      white-space: nowrap;
    }
  }
</style>
</head>
<body>
  <div class="wrap">

    <!-- Top header with Home -->
    <div class="topbar">
      <div>
        <h1>Luno Profit Calculator</h1>
        <div class="muted small">Edit materials, success chances, and prices. All results update instantly.</div>
      </div>
      <a class="home-btn" href="index.html"><span class="arrow">‚Üê</span> Home</a>
    </div>

    <!-- Product & Focus Config -->
    <div class="card">
      <div class="inputs-row">
        <div>
          <label>Product sale price (luno)</label>
          <input id="salePrice" type="number" min="0" step="0.01" value="2012">
        </div>

        <!-- Crafts per day override -->
        <div>
          <label>Crafts per day (override, optional)</label>
          <input id="craftsPerDayInput" type="number" min="0" step="1" placeholder="auto">
        </div>

        <div>
          <label>Focus per craft</label>
          <input id="focusPerCraft" type="number" min="1" step="1" value="10">
        </div>

        <div>
          <label>Daily focus available</label>
          <input id="dailyFocus" type="number" min="0" step="1" value="300">
        </div>

        <!-- NEW: Deposit fee -->
        <div>
          <label>Deposit fee (luno / day)</label>
          <input id="depositFee" type="number" min="0" step="0.01" value="0">
        </div>

        <div>
          <label>Optional: Market fee (%)</label>
          <input id="feePct" type="number" min="0" step="0.01" value="0">
        </div>
      </div>
    </div>

    <!-- Materials -->
    <div class="card" id="materialsCard">
      <div class="flex" style="justify-content:space-between; align-items:center;">
        <h2>Materials</h2>
        <div class="flex">
          <button id="addMaterial" aria-label="Add new material">‚ûï Add material</button>
          <button id="resetToDefaultMaterials" class="muted" aria-label="Reset to default materials">Reset to example</button>
          <button id="exportConfig" class="muted" aria-label="Export configuration">üì§ Export</button>
          <button id="importConfig" class="muted" aria-label="Import configuration">üì• Import</button>
        </div>
      </div>
      <table class="table" id="materialsTable">
        <thead>
          <tr>
            <th style="width:30%">Name</th>
            <th>Qty / craft</th>
            <th>Unit cost (luno)</th>
            <th class="right">Line cost</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="materialsBody"></tbody>
        <tfoot>
          <tr>
            <td colspan="3" class="right total">Total materials cost / craft</td>
            <td class="right total" id="materialsTotal">‚Äî</td>
            <td></td>
          </tr>
        </tfoot>
      </table>
    </div>

    <!-- Success Chances -->
    <div class="card" id="probCard">
      <div class="flex" style="justify-content:space-between; align-items:center;">
        <h2>Success chances (outcome ‚Üí %)</h2>
        <div class="flex">
          <button id="addOutcome" aria-label="Add new outcome">‚ûï Add outcome</button>
          <button id="normalizeProb" class="muted hidden" aria-label="Normalize probabilities to 100%">Normalize to 100%</button>
          <span class="pill hidden" aria-live="polite">Sum: <span id="probSum">‚Äî</span>%</span>
        </div>
      </div>
      <table class="table" id="probTable">
        <thead>
          <tr>
            <th>Items produced</th>
            <th>Chance (%)</th>
            <th class="right">Contribution</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="probBody"></tbody>
        <tfoot>
          <tr>
            <td class="right total" colspan="2">Expected items / craft</td>
            <td class="right total" id="expectedItems">‚Äî</td>
            <td></td>
          </tr>
        </tfoot>
      </table>
      <div id="probWarning" class="warn small" style="display:none;">Warning: probabilities do not sum to 100%. Values will be used as-is.</div>
    </div>

    <!-- Results -->
    <div class="card">
      <h2>Results</h2>
      <div class="grid-2">
        <div class="card">
          <h3>Per Craft</h3>
          <div class="row">
            <div style="grid-column: span 8;">Revenue (after fee)</div>
            <div class="right" style="grid-column: span 4;"><span id="revPerCraft">‚Äî</span> luno</div>
          </div>
          <div class="row">
            <div style="grid-column: span 8;">Materials cost</div>
            <div class="right" style="grid-column: span 4;"><span id="matPerCraft">‚Äî</span> luno</div>
          </div>
          <hr class="hr">
          <div class="row total">
            <div style="grid-column: span 8;">Profit per craft</div>
            <div class="right" style="grid-column: span 4;"><span id="profitPerCraft">‚Äî</span> luno</div>
          </div>
          <div class="row">
            <div style="grid-column: span 8;">Profit per focus</div>
            <div class="right" style="grid-column: span 4;"><span id="profitPerFocus">‚Äî</span> luno/focus</div>
          </div>
          <div class="row">
            <div style="grid-column: span 8;">Break-even sale price</div>
            <div class="right" style="grid-column: span 4;"><span id="breakeven">‚Äî</span> luno</div>
          </div>
        </div>

        <!-- Per Day -->
        <div class="card">
          <h3>Per Day</h3>
          <div class="row">
            <div style="grid-column: span 8;">Crafts per day</div>
            <div class="right" style="grid-column: span 4;"><span id="craftsPerDay">‚Äî</span></div>
          </div>
          <div class="row">
            <div style="grid-column: span 8;">Materials needed</div>
            <div class="right" style="grid-column: span 4;"><span id="matsPerDay">‚Äî</span></div>
          </div>
          <div class="row">
            <div style="grid-column: span 8;">Revenue per day (after fee)</div>
            <div class="right" style="grid-column: span 4;"><span id="revPerDay">‚Äî</span> luno</div>
          </div>
          <div class="row">
            <div style="grid-column: span 8;">Materials cost per day</div>
            <div class="right" style="grid-column: span 4;"><span id="matPerDay">‚Äî</span> luno</div>
          </div>
          <div class="row">
            <div style="grid-column: span 8;">Items crafted per day (expected)</div>
            <div class="right" style="grid-column: span 4;"><span id="itemsPerDay">‚Äî</span></div>
          </div>
          <!-- NEW: show deposit fee impact -->
          <div class="row">
            <div style="grid-column: span 8;">Deposit fee (per day)</div>
            <div class="right" style="grid-column: span 4;"><span id="depositPerDay">‚Äî</span> luno</div>
          </div>

          <hr class="hr">
          <div class="row total">
            <div style="grid-column: span 8;">Profit per day</div>
            <div class="right" style="grid-column: span 4;"><span id="profitPerDay">‚Äî</span> luno</div>
          </div>
        </div>
      </div>
      <div class="footer" id="footerNote"></div>
    </div>
  </div>

  <!-- Loading overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
  </div>

<script>
(function() {
  // ------- Utilities -------
  const fmt = (n) => (!isFinite(n) ? '‚Äî' : Number(n).toLocaleString(undefined, { maximumFractionDigits: 2 }));
  const q = (sel) => document.querySelector(sel);
  const el = (tag, props={}) => Object.assign(document.createElement(tag), props);
  const td = (child, cls) => { const c = el('td'); if (cls) c.className = cls; c.appendChild(child); return c; };

  // Debounce function for performance
  function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  }

  // Loading indicator
  const loadingOverlay = document.getElementById('loadingOverlay');
  
  function showLoading() {
    loadingOverlay.classList.add('show');
  }
  
  function hideLoading() {
    loadingOverlay.classList.remove('show');
  }

  // Debounced compute function
  const debouncedCompute = debounce(() => {
    compute();
    saveState();
  }, 150);

  // ------- Validation -------
  function validateInput(input, min = 0, max = Infinity) {
    const value = parseFloat(input.value);
    const isValid = !isNaN(value) && value >= min && value <= max;
    
    input.classList.remove('error', 'success');
    if (input.value === '') {
      // Empty is okay for optional fields
      return true;
    } else if (isValid) {
      input.classList.add('success');
      return true;
    } else {
      input.classList.add('error');
      return false;
    }
  }

  function showToast(message, type = 'info') {
    const toast = el('div', {
      className: `toast ${type}`,
      innerHTML: message,
      style: `
        position: fixed; top: 20px; right: 20px; z-index: 1000;
        padding: 12px 16px; border-radius: 8px; color: white;
        background: ${type === 'error' ? '#ef4444' : type === 'success' ? '#22c55e' : '#3b82f6'};
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        transform: translateX(100%); transition: transform 0.3s ease;
      `
    });
    
    document.body.appendChild(toast);
    setTimeout(() => toast.style.transform = 'translateX(0)', 10);
    setTimeout(() => {
      toast.style.transform = 'translateX(100%)';
      setTimeout(() => document.body.removeChild(toast), 300);
    }, 3000);
  }

  const STORAGE_KEY = 'metalCraftCalcV1';

  // ------- State -------
  let materials = [];
  let outcomes = [
    { id: crypto.randomUUID(), items: 1, pct: 72 },
    { id: crypto.randomUUID(), items: 2, pct: 26 },
    { id: crypto.randomUUID(), items: 3, pct: 2  },
  ];

  // ------- Persistence -------
  function saveState() {
    const data = {
      materials,
      outcomes,
      salePrice: q('#salePrice').value,
      feePct: q('#feePct').value,
      focusPerCraft: q('#focusPerCraft').value,
      dailyFocus: q('#dailyFocus').value,
      craftsPerDayInput: q('#craftsPerDayInput').value,
      depositFee: q('#depositFee').value
    };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  }

  function loadState() {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return;
    try {
      const data = JSON.parse(raw);
      if (data.materials) materials = data.materials;
      if (data.outcomes) outcomes = data.outcomes;
      if (data.salePrice !== undefined) q('#salePrice').value = data.salePrice;
      if (data.feePct !== undefined) q('#feePct').value = data.feePct;
      if (data.focusPerCraft !== undefined) q('#focusPerCraft').value = data.focusPerCraft;
      if (data.dailyFocus !== undefined) q('#dailyFocus').value = data.dailyFocus;
      if (data.craftsPerDayInput !== undefined) q('#craftsPerDayInput').value = data.craftsPerDayInput;
      if (data.depositFee !== undefined) q('#depositFee').value = data.depositFee;
    } catch(e) {
      console.warn('Failed to load saved data:', e);
    }
  }

  // ------- Materials UI -------
  function renderMaterials() {
    const body = q('#materialsBody');
    body.innerHTML = '';

    materials.forEach((m) => {
      const tr = el('tr');

      const name = el('input', { type:'text', value: m.name ?? '' });
      name.addEventListener('input', () => { m.name = name.value; saveState(); });

      const qty = el('input', { type:'number', min:'0', step:'0.0001', value: m.qty ?? 0 });
      const unit = el('input', { type:'number', min:'0', step:'0.01', value: m.unit ?? 0 });
      const lineTd = el('td', { className: 'right' });

      const updateLine = () => { lineTd.innerText = fmt((+qty.value || 0) * (+unit.value || 0)); };

      qty.addEventListener('input', () => { m.qty = +qty.value; updateLine(); debouncedCompute(); });
      unit.addEventListener('input', () => { m.unit = +unit.value; updateLine(); debouncedCompute(); });

      const rm = el('button', { innerText: 'üóëÔ∏è', className: 'danger' });
      rm.setAttribute('aria-label', `Remove material ${m.name || 'unnamed'}`);
      rm.addEventListener('click', () => { materials = materials.filter(x => x.id !== m.id); renderMaterials(); compute(); saveState(); });

      updateLine();
      tr.append(td(name), td(qty), td(unit), lineTd, td(rm));
      body.appendChild(tr);
    });
  }

  q('#addMaterial').addEventListener('click', () => {
    materials.push({ id: crypto.randomUUID(), name: '', qty: 1, unit: 0 });
    renderMaterials(); compute(); saveState();
  });

  q('#resetToDefaultMaterials').addEventListener('click', () => {
    materials = [
      { id: crypto.randomUUID(), name: 'Ore', qty: 8, unit: 174 },
      { id: crypto.randomUUID(), name: 'Powder', qty: 1, unit: 138 },
    ];
    renderMaterials(); compute(); saveState();
  });

  // Export configuration
  q('#exportConfig').addEventListener('click', () => {
    const config = {
      version: '1.0',
      timestamp: new Date().toISOString(),
      materials,
      outcomes,
      settings: {
        salePrice: q('#salePrice').value,
        feePct: q('#feePct').value,
        focusPerCraft: q('#focusPerCraft').value,
        dailyFocus: q('#dailyFocus').value,
        craftsPerDayInput: q('#craftsPerDayInput').value,
        depositFee: q('#depositFee').value
      }
    };
    
    const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = el('a', { href: url, download: `luno-calculator-config-${new Date().toISOString().split('T')[0]}.json` });
    a.click();
    URL.revokeObjectURL(url);
  });

  // Import configuration
  q('#importConfig').addEventListener('click', () => {
    const input = el('input', { type: 'file', accept: '.json' });
    input.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const config = JSON.parse(e.target.result);
          
          // Validate config structure
          if (!config.materials || !config.outcomes || !config.settings) {
            showToast('Invalid configuration file format.', 'error');
            return;
          }
          
          // Load configuration
          materials = config.materials.map(m => ({ ...m, id: crypto.randomUUID() }));
          outcomes = config.outcomes.map(o => ({ ...o, id: crypto.randomUUID() }));
          
          const s = config.settings;
          q('#salePrice').value = s.salePrice || 0;
          q('#feePct').value = s.feePct || 0;
          q('#focusPerCraft').value = s.focusPerCraft || 1;
          q('#dailyFocus').value = s.dailyFocus || 0;
          q('#craftsPerDayInput').value = s.craftsPerDayInput || '';
          q('#depositFee').value = s.depositFee || 0;
          
          showLoading();
          
          setTimeout(() => {
            renderMaterials();
            renderOutcomes();
            compute();
            saveState();
            hideLoading();
            showToast('Configuration imported successfully!', 'success');
          }, 100);
        } catch (err) {
          showToast('Error parsing configuration file: ' + err.message, 'error');
        }
      };
      reader.readAsText(file);
    });
    input.click();
  });

  // ------- Outcomes UI -------
  function renderOutcomes() {
    const body = q('#probBody');
    body.innerHTML = '';

    outcomes.forEach((o) => {
      const tr = el('tr');
      const items = el('input', { type:'number', min:'0', step:'0.01', value: o.items ?? 0 });
      const pct = el('input', { type:'number', min:'0', step:'0.01', value: o.pct ?? 0 });
      const rm = el('button', { innerText: 'üóëÔ∏è', className: 'danger' });
      const contribTd = el('td', { className:'right' });

      const updateContrib = () => { contribTd.innerText = fmt((+o.items || 0) * ((+o.pct || 0)/100)); };

      items.addEventListener('input', () => { o.items = +items.value; updateContrib(); debouncedCompute(); });
      pct.addEventListener('input', () => { o.pct = +pct.value; updateContrib(); debouncedCompute(); });
      rm.setAttribute('aria-label', `Remove outcome with ${o.items} items`);
      rm.addEventListener('click', () => { outcomes = outcomes.filter(x => x.id !== o.id); renderOutcomes(); compute(); saveState(); });

      updateContrib();
      tr.append(td(items), td(pct), contribTd, td(rm));
      body.appendChild(tr);
    });

    const sumPct = outcomes.reduce((a,b) => a + (+b.pct || 0), 0);
    const exp = outcomes.reduce((a,b) => a + ((+b.items || 0) * ((+b.pct || 0)/100)), 0);
    q('#probSum').innerText = fmt(sumPct);
    q('#expectedItems').innerText = fmt(exp);
    q('#probWarning').style.display = Math.abs(sumPct - 100) < 1e-9 ? 'none' : '';
  }

  q('#addOutcome').addEventListener('click', () => {
    outcomes.push({ id: crypto.randomUUID(), items: 1, pct: 0 });
    renderOutcomes(); compute(); saveState();
  });

  // ------- Inputs -------
  const salePrice         = q('#salePrice');
  const feePct            = q('#feePct');
  const focusPerCraft     = q('#focusPerCraft');
  const dailyFocus        = q('#dailyFocus');
  const craftsPerDayInput = q('#craftsPerDayInput');
  const depositFee        = q('#depositFee');

  [salePrice, feePct, focusPerCraft, dailyFocus, craftsPerDayInput, depositFee].forEach(inp => {
    inp.addEventListener('input', () => { 
      // Validate based on field type
      let isValid = true;
      if (inp === salePrice || inp === depositFee) {
        isValid = validateInput(inp, 0);
      } else if (inp === feePct) {
        isValid = validateInput(inp, 0, 100);
      } else if (inp === focusPerCraft) {
        isValid = validateInput(inp, 1);
      } else if (inp === dailyFocus) {
        isValid = validateInput(inp, 0);
      } else if (inp === craftsPerDayInput) {
        isValid = inp.value === '' || validateInput(inp, 0);
      }
      
      if (isValid) {
        debouncedCompute();
      }
    });
  });

  // ------- Compute -------
  function compute() {
    const matPerCraft = materials.reduce((s,m)=>s+((+m.qty||0)*(+m.unit||0)),0);
    const expectedItems = outcomes.reduce((s,o)=>s+((+o.items||0)*((+o.pct||0)/100)),0);

    const price = +salePrice.value || 0;
    const fee = (+feePct.value || 0)/100;
    const revPerCraft = expectedItems * price * (1 - fee);

    const fpc = (+focusPerCraft.value || 1);
    const profitPerCraft = revPerCraft - matPerCraft;
    const profitPerFocus = profitPerCraft / fpc;
    const breakeven = expectedItems>0&&(1-fee)!==0?matPerCraft/expectedItems/(1-fee):NaN;

    const df = (+dailyFocus.value || 0);
    const computedCrafts = Math.floor(df / fpc);
    const overrideStr = craftsPerDayInput.value?.trim?.() ?? '';
    const craftsPerDay = overrideStr === '' ? computedCrafts : Math.max(0, Math.floor(+overrideStr || 0));

    const matsPerDayUnits = materials.map(m=>({name:m.name||'Material', qty:(+m.qty||0)*craftsPerDay}));
    const matPerDay = matPerCraft * craftsPerDay;
    const revPerDay = revPerCraft * craftsPerDay;
    const itemsPerDay = expectedItems * craftsPerDay;

    const deposit = (+depositFee.value || 0); // per-day flat
    const profitPerDay = revPerDay - matPerDay - deposit;

    q('#materialsTotal').innerText = fmt(matPerCraft);
    q('#expectedItems').innerText = fmt(expectedItems);
    q('#revPerCraft').innerText = fmt(revPerCraft);
    q('#matPerCraft').innerText = fmt(matPerCraft);
    q('#profitPerCraft').innerText = fmt(profitPerCraft);
    q('#profitPerFocus').innerText = fmt(profitPerFocus);
    q('#breakeven').innerText = isFinite(breakeven)?fmt(breakeven):'‚Äî';
    q('#craftsPerDay').innerText = fmt(craftsPerDay);
    q('#revPerDay').innerText = fmt(revPerDay);
    q('#matPerDay').innerText = fmt(matPerDay);
    q('#profitPerDay').innerText = fmt(profitPerDay);
    q('#depositPerDay').innerText = fmt(deposit);
    q('#matsPerDay').innerText = matsPerDayUnits.length?matsPerDayUnits.map(m=>`${fmt(m.qty)} √ó ${m.name}`).join(', '):'‚Äî';
    const itemsEl=q('#itemsPerDay'); if(itemsEl) itemsEl.innerText=fmt(itemsPerDay);

    const pSum = outcomes.reduce((a,b)=>a+(+b.pct||0),0);
    const note=[];
    if(Math.abs(pSum-100)>1e-9) note.push('Probabilities sum ‚â† 100%.');
    if((+feePct.value||0)===0) note.push('No market fee applied.');
    if((+depositFee.value||0)===0) note.push('No deposit fee applied.');
    if(overrideStr!=='') note.push('Crafts/day overridden.');
    q('#footerNote').innerText=note.join('  ');
  }

  // ------- Init -------
  loadState();
  renderMaterials();
  renderOutcomes();
  compute();
})();
</script>
</body>
</html>
