<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Metal Crafting Profit Calculator</title>
<style>
  :root { --gap: 10px; --pad: 12px; --radius: 10px; --muted:#6b7280; }
  * { box-sizing: border-box; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
  body { margin: 0; padding: 20px; background: #0f172a; color: #e5e7eb; }
  h1,h2,h3 { margin: 0 0 8px; }
  .wrap { max-width: 1100px; margin: 0 auto; display: grid; gap: 16px; }
  .card { background: #111827; border: 1px solid #1f2937; border-radius: var(--radius); padding: var(--pad); }
  .row { display: grid; grid-template-columns: repeat(12, 1fr); gap: var(--gap); align-items: center; }
  .row + .row { margin-top: var(--gap); }
  label { font-size: 12px; color: var(--muted); display:block; margin-bottom: 6px; }
  input[type="number"], input[type="text"] {
    width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #374151; background: #0b1220; color: #e5e7eb;
  }
  input[type="number"]:focus, input[type="text"]:focus { outline: 2px solid #2563eb22; border-color: #2563eb66; }
  button { border: 1px solid #374151; background: #0b1220; color: #e5e7eb; padding: 10px 12px; border-radius: 8px; cursor:pointer; }
  button:hover { border-color:#4b5563; background:#0f172a; }
  .primary { background:#1f2937; border-color:#374151; }
  .danger { background:#3b0d0d; border-color:#7f1d1d; }
  .success { color:#34d399; }
  .warn { color:#f59e0b; }
  .muted { color: var(--muted); }
  .flex { display:flex; gap:10px; flex-wrap:wrap; }
  .right { text-align:right; }
  .grid-2 { display:grid; grid-template-columns: 1fr 1fr; gap: 16px; }
  .pill { font-size: 12px; padding: 4px 8px; border-radius: 999px; border:1px solid #374151; background:#0b1220; }
  .hr { height:1px; background:#1f2937; margin: 12px 0; border:0; }
  .table { width:100%; border-collapse: collapse; }
  .table th, .table td { border-bottom:1px solid #1f2937; padding:10px; text-align:left; }
  .table th { color:#9ca3af; font-weight:600; }
  .total { font-weight:700; }
  .footer { color:#9ca3af; font-size:12px; }
  .small { font-size: 12px; }
  .hidden {display: none;}
</style>
</head>
<body>
  <div class="wrap">
    <h1>Metal Crafting Profit Calculator</h1>
    <div class="muted small">Edit materials, success chances, and prices. All results update instantly.</div>

    <!-- Product & Focus Config -->
    <div class="card">
      <div class="row">
        <div class="col" style="grid-column: span 3;">
          <label>Product sale price (luno)</label>
          <input id="salePrice" type="number" min="0" step="0.01" value="2012">
        </div>

        <!-- Crafts per day override -->
        <div class="col" style="grid-column: span 3;">
          <label>Crafts per day (override, optional)</label>
          <input id="craftsPerDayInput" type="number" min="0" step="1" placeholder="auto">
        </div>

        <div class="col" style="grid-column: span 2;">
          <label>Focus per craft</label>
          <input id="focusPerCraft" type="number" min="1" step="1" value="10">
        </div>
        <div class="col" style="grid-column: span 2;">
          <label>Daily focus available</label>
          <input id="dailyFocus" type="number" min="0" step="1" value="300">
        </div>
        <div class="col" style="grid-column: span 2;">
          <label>Optional: Market fee (%)</label>
          <input id="feePct" type="number" min="0" step="0.01" value="0">
        </div>
      </div>
    </div>

    <!-- Materials -->
    <div class="card" id="materialsCard">
      <div class="flex" style="justify-content:space-between; align-items:center;">
        <h2>Materials</h2>
        <div class="flex">
          <button id="addMaterial">➕ Add material</button>
          <button id="resetToDefaultMaterials" class="muted">Reset to example</button>
        </div>
      </div>
      <table class="table" id="materialsTable">
        <thead>
          <tr>
            <th style="width:30%">Name</th>
            <th>Qty / craft</th>
            <th>Unit cost (luno)</th>
            <th class="right">Line cost</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="materialsBody">
          <!-- Rows injected by JS -->
        </tbody>
        <tfoot>
          <tr>
            <td colspan="3" class="right total">Total materials cost / craft</td>
            <td class="right total" id="materialsTotal">—</td>
            <td></td>
          </tr>
        </tfoot>
      </table>
    </div>

    <!-- Success Chances -->
    <div class="card" id="probCard">
      <div class="flex" style="justify-content:space-between; align-items:center;">
        <h2>Success chances (outcome → %)</h2>
        <div class="flex">
          <button id="addOutcome">➕ Add outcome</button>
          <button id="normalizeProb" class="muted hidden">Normalize to 100%</button>
          <span class="pill hidden">Sum: <span id="probSum">—</span>%</span>
        </div>
      </div>
      <table class="table" id="probTable">
        <thead>
          <tr>
            <th>Items produced</th>
            <th>Chance (%)</th>
            <th class="right">Contribution</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="probBody">
          <!-- Rows injected by JS -->
        </tbody>
        <tfoot>
          <tr>
            <td class="right total" colspan="2">Expected items / craft</td>
            <td class="right total" id="expectedItems">—</td>
            <td></td>
          </tr>
        </tfoot>
      </table>
      <div id="probWarning" class="warn small" style="display:none;">Warning: probabilities do not sum to 100%. Values will be used as-is.</div>
    </div>

    <!-- Results -->
    <div class="card">
      <h2>Results</h2>
      <div class="grid-2">
        <div class="card">
          <h3>Per Craft</h3>
          <div class="row">
            <div style="grid-column: span 8;">Revenue (after fee)</div>
            <div class="right" style="grid-column: span 4;"><span id="revPerCraft">—</span> luno</div>
          </div>
          <div class="row">
            <div style="grid-column: span 8;">Materials cost</div>
            <div class="right" style="grid-column: span 4;"><span id="matPerCraft">—</span> luno</div>
          </div>
          <hr class="hr">
          <div class="row total">
            <div style="grid-column: span 8;">Profit per craft</div>
            <div class="right" style="grid-column: span 4;"><span id="profitPerCraft">—</span> luno</div>
          </div>
          <div class="row">
            <div style="grid-column: span 8;">Profit per focus</div>
            <div class="right" style="grid-column: span 4;"><span id="profitPerFocus">—</span> luno/focus</div>
          </div>
          <div class="row">
            <div style="grid-column: span 8;">Break-even sale price</div>
            <div class="right" style="grid-column: span 4;"><span id="breakeven">—</span> luno</div>
          </div>
        </div>

        <!-- Per Day -->
        <div class="card">
          <h3>Per Day</h3>
          <div class="row">
            <div style="grid-column: span 8;">Crafts per day</div>
            <div class="right" style="grid-column: span 4;"><span id="craftsPerDay">—</span></div>
          </div>
          <div class="row">
            <div style="grid-column: span 8;">Materials needed</div>
            <div class="right" style="grid-column: span 4;"><span id="matsPerDay">—</span></div>
          </div>
          <div class="row">
            <div style="grid-column: span 8;">Revenue per day (after fee)</div>
            <div class="right" style="grid-column: span 4;"><span id="revPerDay">—</span> luno</div>
          </div>
          <div class="row">
            <div style="grid-column: span 8;">Materials cost per day</div>
            <div class="right" style="grid-column: span 4;"><span id="matPerDay">—</span> luno</div>
          </div>

          <!-- NEW: items crafted per day -->
          <div class="row">
            <div style="grid-column: span 8;">Items crafted per day (expected)</div>
            <div class="right" style="grid-column: span 4;"><span id="itemsPerDay">—</span></div>
          </div>

          <hr class="hr">
          <div class="row total">
            <div style="grid-column: span 8;">Profit per day</div>
            <div class="right" style="grid-column: span 4;"><span id="profitPerDay">—</span> luno</div>
          </div>
        </div>
      <div class="footer" id="footerNote"></div>
    </div>
  </div>

<script>
(function() {
  // ------- Utilities -------
  const fmt = (n) => (!isFinite(n) ? '—' : Number(n).toLocaleString(undefined, { maximumFractionDigits: 2 }));
  const q = (sel) => document.querySelector(sel);
  const el = (tag, props={}) => Object.assign(document.createElement(tag), props);
  const td = (child, cls) => { const c = el('td'); if (cls) c.className = cls; c.appendChild(child); return c; };

  const STORAGE_KEY = 'metalCraftCalcV1';

  // ------- State -------
  let materials = [];
  let outcomes = [
    { id: crypto.randomUUID(), items: 1, pct: 72 },
    { id: crypto.randomUUID(), items: 2, pct: 26 },
    { id: crypto.randomUUID(), items: 3, pct: 2  },
  ];

  // ------- Persistence -------
  function saveState() {
    const data = {
      materials,
      outcomes,
      salePrice: q('#salePrice').value,
      feePct: q('#feePct').value,
      focusPerCraft: q('#focusPerCraft').value,
      dailyFocus: q('#dailyFocus').value,
      craftsPerDayInput: q('#craftsPerDayInput').value
    };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  }

  function loadState() {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return;
    try {
      const data = JSON.parse(raw);
      if (data.materials) materials = data.materials;
      if (data.outcomes) outcomes = data.outcomes;
      if (data.salePrice !== undefined) q('#salePrice').value = data.salePrice;
      if (data.feePct !== undefined) q('#feePct').value = data.feePct;
      if (data.focusPerCraft !== undefined) q('#focusPerCraft').value = data.focusPerCraft;
      if (data.dailyFocus !== undefined) q('#dailyFocus').value = data.dailyFocus;
      if (data.craftsPerDayInput !== undefined) q('#craftsPerDayInput').value = data.craftsPerDayInput;
    } catch(e) {
      console.warn('Failed to load saved data:', e);
    }
  }

  // ------- Materials UI -------
  function renderMaterials() {
    const body = q('#materialsBody');
    body.innerHTML = '';

    materials.forEach((m) => {
      const tr = el('tr');

      const name = el('input', { type:'text', value: m.name ?? '' });
      name.addEventListener('input', () => { m.name = name.value; saveState(); });

      const qty = el('input', { type:'number', min:'0', step:'0.0001', value: m.qty ?? 0 });
      const unit = el('input', { type:'number', min:'0', step:'0.01', value: m.unit ?? 0 });
      const lineTd = el('td', { className: 'right' });

      const updateLine = () => { lineTd.innerText = fmt((+qty.value || 0) * (+unit.value || 0)); };

      qty.addEventListener('input', () => { m.qty = +qty.value; updateLine(); compute(); saveState(); });
      unit.addEventListener('input', () => { m.unit = +unit.value; updateLine(); compute(); saveState(); });

      const rm = el('button', { innerText: '🗑️', className: 'danger' });
      rm.addEventListener('click', () => { materials = materials.filter(x => x.id !== m.id); renderMaterials(); compute(); saveState(); });

      updateLine();
      tr.append(td(name), td(qty), td(unit), lineTd, td(rm));
      body.appendChild(tr);
    });
  }

  q('#addMaterial').addEventListener('click', () => {
    materials.push({ id: crypto.randomUUID(), name: '', qty: 1, unit: 0 });
    renderMaterials(); compute(); saveState();
  });

  q('#resetToDefaultMaterials').addEventListener('click', () => {
    materials = [
      { id: crypto.randomUUID(), name: 'Ore', qty: 8, unit: 174 },
      { id: crypto.randomUUID(), name: 'Powder', qty: 1, unit: 138 },
    ];
    renderMaterials(); compute(); saveState();
  });

  // ------- Outcomes UI -------
  function renderOutcomes() {
    const body = q('#probBody');
    body.innerHTML = '';

    outcomes.forEach((o) => {
      const tr = el('tr');
      const items = el('input', { type:'number', min:'0', step:'0.01', value: o.items ?? 0 });
      const pct = el('input', { type:'number', min:'0', step:'0.01', value: o.pct ?? 0 });
      const rm = el('button', { innerText: '🗑️', className: 'danger' });
      const contribTd = el('td', { className:'right' });

      const updateContrib = () => { contribTd.innerText = fmt((+o.items || 0) * ((+o.pct || 0)/100)); };

      items.addEventListener('input', () => { o.items = +items.value; updateContrib(); compute(); saveState(); });
      pct.addEventListener('input', () => { o.pct = +pct.value; updateContrib(); compute(); saveState(); });
      rm.addEventListener('click', () => { outcomes = outcomes.filter(x => x.id !== o.id); renderOutcomes(); compute(); saveState(); });

      updateContrib();
      tr.append(td(items), td(pct), contribTd, td(rm));
      body.appendChild(tr);
    });

    const sumPct = outcomes.reduce((a,b) => a + (+b.pct || 0), 0);
    const exp = outcomes.reduce((a,b) => a + ((+b.items || 0) * ((+b.pct || 0)/100)), 0);
    q('#probSum').innerText = fmt(sumPct);
    q('#expectedItems').innerText = fmt(exp);
    q('#probWarning').style.display = Math.abs(sumPct - 100) < 1e-9 ? 'none' : '';
  }

  q('#addOutcome').addEventListener('click', () => {
    outcomes.push({ id: crypto.randomUUID(), items: 1, pct: 0 });
    renderOutcomes(); compute(); saveState();
  });

  // ------- Inputs -------
  const salePrice         = q('#salePrice');
  const feePct            = q('#feePct');
  const focusPerCraft     = q('#focusPerCraft');
  const dailyFocus        = q('#dailyFocus');
  const craftsPerDayInput = q('#craftsPerDayInput');

  [salePrice, feePct, focusPerCraft, dailyFocus, craftsPerDayInput].forEach(inp => {
    inp.addEventListener('input', () => { compute(); saveState(); });
  });

  // ------- Compute -------
  function compute() {
    const matPerCraft = materials.reduce((s,m)=>s+((+m.qty||0)*(+m.unit||0)),0);
    const expectedItems = outcomes.reduce((s,o)=>s+((+o.items||0)*((+o.pct||0)/100)),0);

    const price = +salePrice.value || 0;
    const fee = (+feePct.value || 0)/100;
    const revPerCraft = expectedItems * price * (1 - fee);

    const fpc = (+focusPerCraft.value || 1);
    const profitPerCraft = revPerCraft - matPerCraft;
    const profitPerFocus = profitPerCraft / fpc;
    const breakeven = expectedItems>0&&(1-fee)!==0?matPerCraft/expectedItems/(1-fee):NaN;

    const df = (+dailyFocus.value || 0);
    const computedCrafts = Math.floor(df / fpc);
    const overrideStr = craftsPerDayInput.value?.trim?.() ?? '';
    const craftsPerDay = overrideStr === '' ? computedCrafts : Math.max(0, Math.floor(+overrideStr || 0));

    const matsPerDayUnits = materials.map(m=>({name:m.name||'Material', qty:(+m.qty||0)*craftsPerDay}));
    const matPerDay = matPerCraft * craftsPerDay;
    const revPerDay = revPerCraft * craftsPerDay;
    const profitPerDay = revPerDay - matPerDay;
    const itemsPerDay = expectedItems * craftsPerDay;

    q('#materialsTotal').innerText = fmt(matPerCraft);
    q('#expectedItems').innerText = fmt(expectedItems);
    q('#revPerCraft').innerText = fmt(revPerCraft);
    q('#matPerCraft').innerText = fmt(matPerCraft);
    q('#profitPerCraft').innerText = fmt(profitPerCraft);
    q('#profitPerFocus').innerText = fmt(profitPerFocus);
    q('#breakeven').innerText = isFinite(breakeven)?fmt(breakeven):'—';
    q('#craftsPerDay').innerText = fmt(craftsPerDay);
    q('#revPerDay').innerText = fmt(revPerDay);
    q('#matPerDay').innerText = fmt(matPerDay);
    q('#profitPerDay').innerText = fmt(profitPerDay);
    q('#matsPerDay').innerText = matsPerDayUnits.length?matsPerDayUnits.map(m=>`${fmt(m.qty)} × ${m.name}`).join(', '):'—';
    const itemsEl=q('#itemsPerDay'); if(itemsEl) itemsEl.innerText=fmt(itemsPerDay);

    const pSum = outcomes.reduce((a,b)=>a+(+b.pct||0),0);
    const note=[];
    if(Math.abs(pSum-100)>1e-9) note.push('Probabilities sum ≠ 100%.');
    if((+feePct.value||0)===0) note.push('No market fee applied.');
    if(overrideStr!=='') note.push('Crafts/day overridden.');
    q('#footerNote').innerText=note.join('  ');
  }

  // ------- Init -------
  loadState();
  renderMaterials();
  renderOutcomes();
  compute();
})();
</script>
</body>
</html>
